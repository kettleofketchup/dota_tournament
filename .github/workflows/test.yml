name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull pre-built Docker images
      run: |
        docker pull ghcr.io/kettleofketchup/dtx_website/frontend:latest || echo "Frontend image not found, will build locally"
        docker pull ghcr.io/kettleofketchup/dtx_website/backend:latest || echo "Backend image not found, will build locally"
        docker pull ghcr.io/kettleofketchup/dtx_website/nginx:latest || echo "Nginx image not found, will build locally"

    - name: Start test environment
      run: |
        docker compose --project-directory . -f docker/docker-compose.test.yaml up -d

        # Wait for services to be ready
        echo "Waiting for backend to be ready..."
        timeout 120 bash -c 'until curl -f http://localhost:8000/api/health/ 2>/dev/null; do sleep 2; done' || echo "Backend health check timeout"

        echo "Waiting for frontend to be ready..."
        timeout 120 bash -c 'until curl -f http://localhost:3000 2>/dev/null; do sleep 2; done' || echo "Frontend health check timeout"

        # Show running containers for debugging
        docker compose --project-directory . -f docker/docker-compose.test.yaml ps

    - name: Run Cypress tests in frontend container
      run: |
        # Install Cypress if not already in the container
        docker compose --project-directory . -f docker/docker-compose.test.yaml exec -T frontend npx cypress install

        # Run the headless e2e tests
        docker compose --project-directory . -f docker/docker-compose.test.yaml exec -T frontend npm run test:e2e:headless
      env:
        # Suppress D-Bus errors in CI environment
        DBUS_SESSION_BUS_ADDRESS: ""
        TERM: xterm-256color
        CI: true
        ELECTRON_ENABLE_LOGGING: false

    - name: Clean up Docker containers
      if: always()
      run: |
        # Stop and remove test containers
        docker compose --project-directory . -f docker/docker-compose.test.yaml down -v || true
        # Clean up any remaining containers
        docker container prune -f || true
        docker volume prune -f || true
